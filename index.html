<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ä°nterkom Kontrol Paneli</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body { font-family:Arial; margin:0; padding:0; background:#f5f6fa; display:flex; flex-direction:column; min-height:100vh; }
  
  /* Login Form */
  #loginDiv { display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; }
  #loginDiv input { padding:10px; margin:5px; width:200px; font-size:16px; }
  #loginDiv button { padding:10px 20px; font-size:16px; cursor:pointer; }

  /* Panel */
  #panelDiv { display:none; flex-direction:column; min-height:100vh; }

  header { display:flex; justify-content:space-between; align-items:center; padding:10px 15px; background:#2f3640; color:white; font-weight:bold; flex-wrap:wrap; }
  header div { font-size:16px; }
  #wifiStatus span { margin-left:5px; color:#44bd32; }
  #callCounter { color:#fbc531; }

  main { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; }
  .button { padding:20px 50px; margin:15px; font-size:22px; border:none; border-radius:12px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:0.3s; width:80%; max-width:300px; text-align:center; }
  .start { background:#44bd32; color:white; }
  .start:hover { background:#2ecc71; }
  .stop { background:#e84118; color:white; }
  .stop:hover { background:#c23616; }

  #statusContainer { margin-top:20px; font-weight:bold; text-align:center; font-size:20px; }
  #statusContainer span { display:block; margin-top:10px; font-size:22px; }

  #networkAlert { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(255,0,0,0.9); color:white; font-size:50px; font-weight:bold; text-align:center; line-height:100vh; z-index:9999; }
</style>
</head>
<body>

<!-- Login Form -->
<div id="loginDiv">
  <h2>Ä°nterkom Panel GiriÅŸi</h2>
  <input id="user" placeholder="KullanÄ±cÄ± AdÄ±"><br>
  <input id="pass" placeholder="Åžifre" type="password"><br>
  <button onclick="checkLogin()">GiriÅŸ Yap</button>
</div>

<!-- Panel -->
<div id="panelDiv">
  <header>
    <div id="hiveStatus">HiveMQ'ya BaÄŸlÄ±</div>
    <div id="wifiStatus">Wi-Fi durumu: <span>ðŸŸ¢ ONLINE</span></div>
    <div id="callCounter">Gelen Ã‡aÄŸrÄ± SayÄ±sÄ±: 0</div>
  </header>

  <main>
    <button class="button start" onclick="talk('relay1', true)">KonuÅŸmayÄ± BaÅŸlat</button>
    <button class="button stop" onclick="talk('relay2', false)">KonuÅŸmayÄ± Kapat</button>
    <div id="statusContainer">
      Ä°nterkom Durumu
      <span id="micStatus">Mikrofon KapalÄ±</span>
    </div>
  </main>
</div>

<div id="networkAlert">AÄž BAÄžLANTISI YOK</div>

<script>
/* ------------------- KullanÄ±cÄ± GiriÅŸi ------------------- */
const USERNAME = "admin";
const PASSWORD = "admin135";

function checkLogin(){
  const u = document.getElementById("user").value;
  const p = document.getElementById("pass").value;

  if(u === USERNAME && p === PASSWORD){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("panelDiv").style.display="flex";
  } else{
    alert("HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!");
  }
}
/* -------------------------------------------------------- */

let counter = localStorage.getItem("callCounter") ? parseInt(localStorage.getItem("callCounter")) : 0;
const callCounterDiv = document.getElementById("callCounter");
callCounterDiv.innerText = "Gelen Ã‡aÄŸrÄ± SayÄ±sÄ±: " + counter;

const wifiDiv = document.getElementById("wifiStatus");
const networkAlert = document.getElementById("networkAlert");
const micStatus = document.getElementById("micStatus");

const options = {
  username:"kemal123",
  password:"Kemal12345",
  clean:true,
  connectTimeout:4000,
  reconnectPeriod:4000
};

const client = mqtt.connect("wss://6db25b9004e64ab084db4a92d1576615.s1.eu.hivemq.cloud:8884/mqtt", options);

let lastWifiMsgTime = Date.now();
const WIFI_TIMEOUT = 5000;

client.on("connect", () => {
  console.log("âœ… HiveMQ'ya baÄŸlandÄ±!");
  client.subscribe("wifiStatus");
  client.subscribe("micStatus");
});

client.on("message", (topic, payload) => {
  const message = payload.toString();

  if(topic === "wifiStatus"){
    lastWifiMsgTime = Date.now();
    if(message === "ONLINE"){
      wifiDiv.innerHTML = 'Wi-Fi durumu: <span style="color:#44bd32">ðŸŸ¢ ESP internete baÄŸlÄ±</span>';
      networkAlert.style.display="none";
    } else {
      wifiDiv.innerHTML = 'Wi-Fi durumu: <span style="color:#e84118">ðŸ”´ ESP baÄŸlantÄ±sÄ± yok</span>';
      networkAlert.style.display="block";
    }
  }

  if(topic === "micStatus"){
    if(message === "ON"){
      micStatus.innerText="Mikrofon AÃ§Ä±k, KonuÅŸabilirsiniz!";
      micStatus.style.color="#44bd32";
    } else {
      micStatus.innerText="Mikrofon KapalÄ±, KonuÅŸma Bitti!";
      micStatus.style.color="#e84118";
    }
  }
});

setInterval(()=>{
  if(Date.now() - lastWifiMsgTime > WIFI_TIMEOUT){
    wifiDiv.innerHTML = 'Wi-Fi durumu: <span style="color:#e84118">ðŸ”´ ESP baÄŸlantÄ±sÄ± yok</span>';
    networkAlert.style.display="block";
  }
}, 1000);

function talk(topic, isStart){
  counter++;
  callCounterDiv.innerText = "Gelen Ã‡aÄŸrÄ± SayÄ±sÄ±: "+counter;
  localStorage.setItem("callCounter", counter);

  client.publish(topic,"ON");
  setTimeout(()=>{ client.publish(topic,"OFF"); },2000);
}
</script>

</body>
</html>
