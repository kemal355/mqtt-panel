<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>İnterkom Kontrol Paneli</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }

    header {
      display: flex;
      justify-content: space-between;
      padding: 10px 20px;
      background: #2f3640;
      color: white;
      font-weight: bold;
      align-items: center;
    }

    #wifiStatus span {
      color: #44bd32;
      margin-left: 5px;
    }

    #callCounter {
      color: #fbc531;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 50px;
    }

    .button {
      padding: 20px 40px;
      margin: 15px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: 0.3s;
    }

    .start {
      background: #44bd32;
      color: white;
    }

    .start:hover {
      background: #2ecc71;
    }

    .stop {
      background: #e84118;
      color: white;
    }

    .stop:hover {
      background: #c23616;
    }

    #status {
      margin-top: 30px;
      font-weight: bold;
      text-align: center;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <header>
    <div id="wifiStatus">Wi-Fi durumu: <span>🟢 ONLINE</span></div>
    <div id="callCounter">Yapılan Arama: 0</div>
  </header>

  <main>
    <button class="button start" onclick="talk('relay1', true)">Konuşmayı Başlat</button>
    <button class="button stop" onclick="talk('relay2', false)">Konuşmayı Kapat</button>
  </main>

  <div id="status">🔴 Bağlantı yok</div>

  <script>
    let counter = 0;

    const options = {
      username: "kemal123",
      password: "Kemal12345",
      clean: true,
      connectTimeout: 4000,
      reconnectPeriod: 4000
    };

    const client = mqtt.connect("wss://6db25b9004e64ab084db4a92d1576615.s1.eu.hivemq.cloud", options);

    const wifiDiv = document.getElementById("wifiStatus");
    const statusDiv = document.getElementById("status");

    client.on("connect", () => {
      console.log("✅ HiveMQ'ya bağlandı!");
      statusDiv.innerHTML = "🟢 HiveMQ'ya bağlı";

      client.subscribe("wifiStatus");
    });

    client.on("message", (topic, payload) => {
      if(topic.toString() === "wifiStatus"){
        const value = payload.toString();
        if(value === "ONLINE"){
          wifiDiv.innerHTML = 'Wi-Fi durumu: <span style="color:#44bd32">🟢 ONLINE</span>';
        } else {
          wifiDiv.innerHTML = 'Wi-Fi durumu: <span style="color:#e84118">🔴 OFFLINE</span>';
        }
      }
    });

    client.on("error", (err) => {
      console.error("❌ Bağlantı hatası: ", err);
      statusDiv.innerHTML = "🔴 Bağlantı hatası";
    });

    client.on("close", () => {
      statusDiv.innerHTML = "🔴 Bağlantı koptu";
    });

    function talk(topic, isStart) {
      counter++;
      document.getElementById("callCounter").innerText = "Yapılan Arama: " + counter;

      client.publish(topic, "ON");
      setTimeout(() => {
        client.publish(topic, "OFF");
      }, 2000);

      if(isStart){
        statusDiv.innerHTML = "🎤 Mikrofon Açık, Konuşabilirsiniz!";
        statusDiv.style.color = "#44bd32";
      } else {
        statusDiv.innerHTML = "🔇 Mikrofon Kapalı, Konuşma Bitti!";
        statusDiv.style.color = "#e84118";
      }
    }
  </script>
</body>
</html>
