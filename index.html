<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phone2 Web Panel</title>
<style>
  body { font-family: Arial,sans-serif; margin:0; padding:20px; background:#f0f8ff; display:flex; flex-direction:column; align-items:center; }
  h1 { color:#004d40; }
  
  #incomingCall { display:none; padding:20px; background:#ff0000; color:white; border-radius:15px; margin-bottom:20px; font-size:22px; font-weight:bold; text-align:center; animation: pulseAnim 1s infinite; }
  #inCall { display:none; padding:20px; background:#4caf50; color:white; border-radius:15px; margin-bottom:20px; font-size:22px; font-weight:bold; text-align:center; }

  button { font-size:20px; padding:12px 30px; margin:10px; border:none; border-radius:10px; cursor:pointer; }
  #acceptCall { background:#43a047; color:white; }
  #rejectCall, #endCall { background:#e53935; color:white; }

  #micVisualizer { width:200px; height:50px; background:#ccc; margin-top:20px; border-radius:5px; overflow:hidden; }
  #micBar { height:100%; width:0%; background:#43a047; transition: width 0.1s; }

  @keyframes pulseAnim { 0%{opacity:0.5;} 50%{opacity:1;} 100%{opacity:0.5;} }
</style>
</head>
<body>

<h1>Phone2 Panel</h1>
<div id="incomingCall">İNTERKOM ÇALIYOR!</div>
<div id="inCall">Konuşabilirsiniz</div>

<button id="acceptCall" style="display:none;">Görüşmeyi Kabul Et</button>
<button id="rejectCall" style="display:none;">Görüşmeyi Reddet</button>
<button id="endCall" style="display:none;">Görüşmeyi Sonlandır</button>

<div id="micVisualizer"><div id="micBar"></div></div>

<audio id="remoteAudio" autoplay></audio>
<audio id="ringTone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" preload="auto"></audio>

<script>
const ws = new WebSocket("wss://sesl-gorusme.onrender.com/ws");
let pc;
let localStream;

const remoteAudio = document.getElementById('remoteAudio');
const incomingDiv = document.getElementById('incomingCall');
const inCallDiv = document.getElementById('inCall');
const acceptBtn = document.getElementById('acceptCall');
const rejectBtn = document.getElementById('rejectCall');
const endBtn = document.getElementById('endCall');
const ringTone = document.getElementById('ringTone');
const micBar = document.getElementById('micBar');

// Audio Visualizer
let audioContext, analyser, dataArray;
function initVisualizer(stream){
  audioContext = new AudioContext();
  const source = audioContext.createMediaStreamSource(stream);
  analyser = audioContext.createAnalyser();
  source.connect(analyser);
  analyser.fftSize = 64;
  dataArray = new Uint8Array(analyser.frequencyBinCount);
  requestAnimationFrame(updateVisualizer);
}
function updateVisualizer(){
  if(analyser){
    analyser.getByteFrequencyData(dataArray);
    let sum = dataArray.reduce((a,b)=>a+b,0);
    let avg = sum/dataArray.length;
    micBar.style.width = Math.min(100, avg) + '%';
  }
  requestAnimationFrame(updateVisualizer);
}

// ICE Servers
const iceServers = [
  { urls: "stun:stun.relay.metered.ca:80" },
  { urls: "turn:standard.relay.metered.ca:80", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" },
  { urls: "turn:standard.relay.metered.ca:443", username: "d648d4967e580d04e7c7b9be", credential: "evt4C7YBa+aWhUrI" }
];

// Çağrı geldiğinde göster
ws.onmessage = async (msg)=>{
  const data = JSON.parse(msg.data);

  if(data.type === "incomingCall"){ 
    incomingDiv.style.display = 'block';
    acceptBtn.style.display = 'inline-block';
    rejectBtn.style.display = 'inline-block';
    ringTone.play();
  }

  if(data.type === "offer"){
    if(!pc){
      pc = new RTCPeerConnection({iceServers});
      pc.ontrack = (event)=> { remoteAudio.srcObject = event.streams[0]; };
      pc.onicecandidate = (event)=>{ if(event.candidate) ws.send(JSON.stringify({type:"candidate", candidate:event.candidate})); };
    }
    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    localStream.getTracks().forEach(track=>pc.addTrack(track, localStream));
    initVisualizer(localStream);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({type:"answer", answer}));
  }

  if(data.type==="candidate" && pc){
    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
  }

  if(data.type === "callEnded"){
    endCall();
  }
};

// Çağrıyı bitir/görünümü temizle
function endCall(){
  if(pc){
    pc.getSenders().forEach(sender=>sender.track.stop());
    pc.close();
    pc=null;
    localStream=null;
  }
  remoteAudio.srcObject=null;
  micBar.style.width='0%';

  incomingDiv.style.display='none';
  inCallDiv.style.display='none';
  acceptBtn.style.display='none';
  rejectBtn.style.display='none';
  endBtn.style.display='none';

  ringTone.pause();
  ringTone.currentTime=0;
}

// Kabul et
acceptBtn.onclick = async () => {
  ringTone.pause();
  ringTone.currentTime=0;

  incomingDiv.style.display='none';
  acceptBtn.style.display='none';
  rejectBtn.style.display='none';

  inCallDiv.style.display='block';
  endBtn.style.display='inline-block';

  ws.send(JSON.stringify({type:"callAccepted"}));
};

// Reddet
rejectBtn.onclick = () => {
  ws.send(JSON.stringify({type:"callEnded"}));
  endCall();
};

// Görüşmeyi sonlandır
endBtn.onclick = () => {
  ws.send(JSON.stringify({type:"callEnded"}));
  endCall();
};
</script>
</body>
</html>
