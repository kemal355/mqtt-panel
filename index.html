<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>İnterkom Kontrol Paneli</title>
<style>
  body { font-family: Arial; text-align:center; margin-top:50px; }
  #wifi { font-weight:bold; margin-bottom:20px; }
  #callCount { font-size:24px; margin:20px 0; }
  button { font-size:18px; padding:10px 20px; margin:10px; }
  #micStatus { font-size:20px; margin-top:20px; color:blue; }
</style>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<h1>İnterkom Kontrol Paneli</h1>
<div id="wifi">WiFi Durumu: <span id="wifiState">Bağlanıyor...</span></div>
<div id="callCount">Gelen Çağrı Sayısı: <span id="count">0</span></div>

<button id="startCall">Konuşmayı Başlat</button>
<button id="stopCall">Konuşmayı Kapat</button>

<div id="micStatus"></div>

<script>
  // Sayaç localStorage ile
  let count = localStorage.getItem('callCount') || 0;
  document.getElementById('count').innerText = count;

  // MQTT bağlantısı
  const client  = mqtt.connect('wss://YOUR_HIVEMQ_CLUSTER:8884/mqtt', {
    username:'kemal123',
    password:'Kemal12345'
  });

  client.on('connect', function () {
    console.log('MQTT bağlandı');
    client.subscribe('wifiStatus');
    client.subscribe('micStatus');
    client.subscribe('relay1');
  });

  client.on('message', function (topic, message) {
    const msg = message.toString();
    if(topic === 'wifiStatus'){
      document.getElementById('wifiState').innerText = msg;
      document.getElementById('wifiState').style.color = (msg === 'ONLINE') ? 'green' : 'red';
    }
    if(topic === 'micStatus'){
      if(msg === 'ON'){
        document.getElementById('micStatus').innerText = 'Mikrofon Açık, Konuşabilirsiniz!';
      } else {
        document.getElementById('micStatus').innerText = 'Mikrofon Kapalı, Konuşma Bitti!';
      }
      setTimeout(()=>{ document.getElementById('micStatus').innerText = ''; }, 3000);
    }
    if(topic === 'relay1'){
      count++;
      localStorage.setItem('callCount', count);
      document.getElementById('count').innerText = count;
    }
  });

  document.getElementById('startCall').addEventListener('click', ()=>{
    client.publish('relay1','TRIG'); // Tek tetik
  });

  document.getElementById('stopCall').addEventListener('click', ()=>{
    client.publish('relay2','TRIG');
  });

</script>
</body>
</html>
