<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phone2 Web Panel</title>
<style>
body { font-family: Arial,sans-serif; margin:0; padding:0; background: linear-gradient(to bottom,#e0f7fa,#80deea); display:flex; flex-direction:column; align-items:center; min-height:100vh; }
h1 { margin:20px 0; font-size:28px; color:#004d40; text-shadow:1px 1px 2px #ccc; }

#panel { display:flex; flex-direction:column; align-items:center; }
#statusText { font-size:22px; font-weight:bold; color:#00695c; margin-top:20px; min-height:30px; text-align:center; transition: all 0.3s; }

#micVisualizer { width:200px; height:50px; background:#ccc; margin-top:20px; border-radius:5px; overflow:hidden; }
#micBar { height:100%; width:0%; background:#43a047; transition: width 0.1s; }

button { font-size:20px; padding:12px 30px; border:none; border-radius:10px; cursor:pointer; margin:10px; }
#startCall { background:#43a047; color:white; }
#stopCall { background:#e53935; color:white; }
</style>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>

<h1>Phone2 Panel</h1>
<div id="statusText">Durum Bekleniyor...</div>
<button id="startCall" disabled>Konuşmayı Başlat</button>
<button id="stopCall" disabled>Konuşmayı Kapat</button>

<div id="micVisualizer"><div id="micBar"></div></div>

<audio id="ringTone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" preload="auto"></audio>

<script>
const client = mqtt.connect('wss://6db25b9004e64ab084db4a92d1576615.s1.eu.hivemq.cloud:8884/mqtt', {
    username: 'kemal123',
    password: 'Kemal12345'
});

let localStream, audioContext, analyser, dataArray;

const statusText = document.getElementById('statusText');
const startBtn = document.getElementById('startCall');
const stopBtn = document.getElementById('stopCall');
const micBar = document.getElementById('micBar');
const ringTone = document.getElementById('ringTone');

function initVisualizer(stream){
    audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(stream);
    analyser = audioContext.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 64;
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    requestAnimationFrame(updateVisualizer);
}

function updateVisualizer(){
    if(analyser){
        analyser.getByteFrequencyData(dataArray);
        let sum = dataArray.reduce((a,b)=>a+b,0);
        let avg = sum/dataArray.length;
        micBar.style.width = Math.min(100, avg) + '%';
    }
    requestAnimationFrame(updateVisualizer);
}

// MQTT bağlantısı
client.on('connect', ()=> {
    console.log("Phone2 MQTT bağlı");
    client.subscribe('relay1'); // çağrı tetiklenecek topic
});

client.on('message', async (topic, message)=>{
    const msg = message.toString();

    if(topic==='relay1' && msg==='TRIG'){
        statusText.innerText = "OPERATÖR ARANIYOR";
        ringTone.play();

        try {
            localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
            initVisualizer(localStream);
            startBtn.disabled = false;
            stopBtn.disabled = false;
        } catch(err){
            console.error("Mikrofon izni reddedildi", err);
            statusText.innerText = "Mikrofon izni gerekli!";
        }
    }
});

startBtn.onclick = ()=> {
    statusText.innerText = "Konuşma Başladı";
    ringTone.pause(); ringTone.currentTime=0;
};

stopBtn.onclick = ()=> {
    if(localStream){
        localStream.getTracks().forEach(track => track.stop());
        localStream=null;
    }
    statusText.innerText = "Konuşma Bitti";
    micBar.style.width='0%';
    startBtn.disabled=true;
    stopBtn.disabled=true;
};
</script>

</body>
</html>
