<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ä°nterkom Kontrol Paneli</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:0;
    background:#f5f6fa;
  }
  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 15px;
    background:#2f3640;
    color:white;
    font-weight:bold;
    flex-wrap:wrap;
  }
  header div { font-size:16px; }
  #wifiStatus span { margin-left:5px; color:#44bd32; }
  #callCounter { color:#fbc531; }

  main {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    margin-top:50px;
  }
  .button {
    padding:20px 50px;
    margin:15px;
    font-size:22px;
    border:none;
    border-radius:12px;
    cursor:pointer;
    box-shadow:0 2px 6px rgba(0,0,0,0.2);
    transition:0.3s;
    width:80%;
    max-width:300px;
  }
  .start { background:#44bd32; color:white; }
  .start:hover { background:#2ecc71; }
  .stop { background:#e84118; color:white; }
  .stop:hover { background:#c23616; }

  #statusContainer {
    margin-top:30px;
    font-weight:bold;
    text-align:right;
    padding:10px 15px;
  }
  #statusContainer span { font-size:20px; display:block; }

  #networkAlert {
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background-color:rgba(255,0,0,0.9);
    color:white;
    font-size:50px;
    font-weight:bold;
    text-align:center;
    line-height:100vh;
    z-index:9999;
  }
</style>
</head>
<body>

<header>
  <div id="hiveStatus">HiveMQ'ya BaÄŸlÄ±</div>
  <div id="wifiStatus">Wi-Fi durumu: <span>ðŸŸ¢ ONLINE</span></div>
  <div id="callCounter">YapÄ±lan Arama: 0</div>
</header>

<main>
  <button class="button start" onclick="talk('relay1', true)">KonuÅŸmayÄ± BaÅŸlat</button>
  <button class="button stop" onclick="talk('relay2', false)">KonuÅŸmayÄ± Kapat</button>
</main>

<div id="statusContainer">
  Ä°nterkom Durumu
  <span id="micStatus">Mikrofon KapalÄ±</span>
</div>

<div id="networkAlert">AÄž BAÄžLANTISI YOK</div>

<script>
let counter = 0;

const options = {
  username:"kemal123",
  password:"Kemal12345",
  clean:true,
  connectTimeout:4000,
  reconnectPeriod:4000
};

const client = mqtt.connect("wss://6db25b9004e64ab084db4a92d1576615.s1.eu.hivemq.cloud:8884/mqtt", options);

const wifiDiv = document.getElementById("wifiStatus");
const networkAlert = document.getElementById("networkAlert");
const micStatus = document.getElementById("micStatus");
const callCounter = document.getElementById("callCounter");

client.on("connect", () => {
  console.log("âœ… HiveMQ'ya baÄŸlandÄ±!");
  client.subscribe("wifiStatus");
});

client.on("message", (topic, payload) => {
  if(topic.toString() === "wifiStatus"){
    const value = payload.toString();
    if(value === "ONLINE"){
      wifiDiv.innerHTML = 'Wi-Fi durumu: <span style="color:#44bd32">ðŸŸ¢ ESP internete baÄŸlÄ±</span>';
      networkAlert.style.display="none";
    } else {
      wifiDiv.innerHTML = 'Wi-Fi durumu: <span style="color:#e84118">ðŸ”´ ESP baÄŸlantÄ±sÄ± yok</span>';
      networkAlert.style.display="block";
    }
  }
});

client.on("error", (err) => { console.error(err); });
client.on("close", () => { networkAlert.style.display="block"; });

function talk(topic, isStart){
  counter++;
  callCounter.innerText = "YapÄ±lan Arama: "+counter;

  client.publish(topic,"ON");
  setTimeout(()=>{ client.publish(topic,"OFF"); },2000);

  if(isStart){
    micStatus.innerText="Mikrofon AÃ§Ä±k, KonuÅŸabilirsiniz!";
    micStatus.style.color="#44bd32";
  } else{
    micStatus.innerText="Mikrofon KapalÄ±, KonuÅŸma Bitti!";
    micStatus.style.color="#e84118";
  }
}
</script>

</body>
</html>
